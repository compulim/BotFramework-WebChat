<!DOCTYPE html>
<html lang="en-US">
  <head>
    <link href="/assets/index.css" rel="stylesheet" type="text/css" />
    <script crossorigin="anonymous" src="/test-harness.js"></script>
    <script crossorigin="anonymous" src="/test-page-object.js"></script>
    <script crossorigin="anonymous" src="/__dist__/webchat-es5.js"></script>
  </head>
  <body>
    <div id="webchat"></div>
    <script>
      function findElement(selectors, predicate) {
        return [...document.querySelectorAll(selectors)].find(predicate);
      }

      function clickButtonWithText(text) {
        return host.click(findElement('.ac-pushButton', ({ innerText }) => innerText === text));
      }

      function cardStateBecame(state) {
        return pageConditions.became(
          `Card state become "${state}"`,
          () => findElement('.ac-textBlock', textBlock => textBlock.innerText === `Card state: ${state}`),
          1000
        );
      }

      run(async function () {
        const directLine = testHelpers.createDirectLineWithTranscript(
          [
            'Ad quis dolore reprehenderit dolor irure pariatur exercitation officia pariatur consequat pariatur incididunt. Sunt enim in ad esse laborum sint ullamco deserunt. Culpa mollit sunt do incididunt tempor excepteur amet. Non aliqua deserunt tempor commodo adipisicing dolore. Est Lorem nisi esse culpa nulla tempor occaecat velit occaecat nisi minim. Consequat proident pariatur eiusmod ullamco nulla dolore ad velit dolor. Adipisicing exercitation in ullamco velit commodo nisi qui minim anim.',
            'Esse ad cupidatat laborum aute do occaecat cillum laboris eiusmod commodo duis. Consequat do consectetur eiusmod reprehenderit occaecat dolor nisi pariatur nostrud pariatur occaecat tempor duis adipisicing. Duis adipisicing mollit minim tempor. Duis consectetur ea sunt officia commodo do. Anim et in do et nostrud elit commodo esse velit dolore sit labore. Labore tempor et eu in laborum minim commodo consequat tempor.',
            'Irure do est veniam enim duis aute ea culpa ex commodo sit in nisi labore. Esse nulla eu incididunt ullamco amet aliquip ut do. Voluptate ut excepteur ipsum excepteur dolore cillum esse laboris ut consectetur aliqua.',
            {
              attachments: [
                {
                  content: {
                    type: 'AdaptiveCard',
                    body: [
                      {
                        text: 'Card state: **Root**',
                        type: 'TextBlock'
                      }
                    ],
                    actions: [
                      {
                        data: {
                          hello: 'World!'
                        },
                        title: 'Action.Submit: Send a "PostBack"',
                        type: 'Action.Submit'
                      }
                    ],
                    $schema: 'http://adaptivecards.io/schemas/adaptive-card.json',
                    version: '1.4'
                  },
                  contentType: 'application/vnd.microsoft.card.adaptive'
                }
              ],
              from: {
                id: 'bot',
                role: 'bot'
              },
              id: '1',
              type: 'message'
            },
            'Last message'
          ],
          {
            overridePostActivity: activity => {
              if (activity.type === 'message' && activity.value) {
                directLine.activityDeferredObservable.next(
                  `You sent a post back:\n\n\`\`\`\n${JSON.stringify(activity.value, null, 2)}\n\`\`\``
                );
              }
            }
          }
        );

        const store = testHelpers.createStore();

        WebChat.renderWebChat(
          {
            directLine,
            store
          },
          document.getElementById('webchat')
        );

        // GIVEN: Adaptive Applet showing Action.Submit button with value of { hello: 'World!' }.
        await pageConditions.uiConnected();
        await pageConditions.numActivitiesShown(5);
        await pageConditions.scrollToBottomCompleted();

        // GIVEN: The scroll view is one above the bottom.
        const transcriptScrollable = pageElements.transcriptScrollable();

        transcriptScrollable.scrollTop = pageElements.activities()[4].offsetTop - transcriptScrollable.offsetHeight;

        await host.snapshot();

        // WHEN: The Action.Submit button is clicked.
        await clickButtonWithText('Action.Submit: Send a "PostBack"');

        // THEN: A post back message { hello: 'World!' } should be sent.
        await pageConditions.numActivitiesShown(6);

        expect(pageElements.activities()[5].querySelector('.webchat__bubble__content')).toHaveProperty(
          'innerText',
          'You sent a post back:\n\n{\n  "hello": "World!"\n}\n'
        );

        // THEN: The Action.Submit button should be pushed.
        const button = document.querySelector('.ac-pushButton');

        expect(button.getAttribute('aria-pressed')).toBe('true');
        expect(button.getAttribute('role')).toBe('button');

        // THEN: It should scroll to the bottom.
        await pageConditions.scrollToBottomCompleted();

        await host.snapshot();
      });
    </script>
  </body>
</html>
