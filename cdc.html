<!DOCTYPE html>
<html lang="en-US">
  <head>
    <title>Web Chat: Accessibility fixes after 4.9.1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--
      This CDN points to the latest official release of Web Chat. If you need to test against Web Chat's latest bits, please refer to pointing to Web Chat's MyGet feed:
      https://github.com/microsoft/BotFramework-WebChat#how-to-test-with-web-chats-latest-bits
    -->
    <script src="https://github.com/compulim/BotFramework-WebChat/releases/download/dev-fix-a11y-post-4.9.1/webchat-es5.js"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/react@16.8.6/umd/react.production.min.js"></script>
    <!-- <script src="http://localhost:5000/webchat-es5.js"></script> -->
    <style>
      html,
      body {
        background-color: #fcfcfc;
        height: 100%;
      }

      body {
        margin: 0;
      }

      #version {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans',
          'Helvetica Neue', sans-serif;
        left: 10px;
        opacity: 0.5;
        position: absolute;
        top: 10px;
      }

      #webchat {
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        height: 100%;
        margin: auto;
        max-width: 480px;
        min-width: 360px;
      }
    </style>
  </head>
  <body>
    <div id="webchat" role="main"></div>
    <div id="version"></div>
    <script>
      // In this demo, we are using Direct Line token from MockBot.
      // To talk to your bot, you should use the token exchanged using your Direct Line secret.
      // You should never put the Direct Line secret in the browser or client app.
      // https://docs.microsoft.com/en-us/azure/bot-service/rest-api/bot-framework-rest-direct-line-3-0-authentication

      // This code is modified to run in browser without async and Promise support
      function fetchCDCToken() {
        return window
          .fetch('https://covid19healthbot.cdc.gov/chatBot?userId=' + Math.random().toString(36).substr(2, 10), {
            method: 'POST'
          })
          .then(function (res) {
            return res.text();
          })
          .then(function (jwt) {
            return JSON.parse(atob(jwt.split('.')[1])).connectorToken;
          });
      }

      function fetchMockBotToken() {
        return window
          .fetch('https://webchat-mockbot.azurewebsites.net/directline/token', { method: 'POST' })
          .then(function (res) {
            return res.json();
          })
          .then(function (json) {
            return json.token;
          });
      }

      function createStore(invoke, initialSendBoxText) {
        return window.WebChat.createStore({}, function () {
          return function (next) {
            return function (action) {
              if (action.type === 'DIRECT_LINE/CONNECT_FULFILLED') {
                initialSendBoxText &&
                  next({
                    type: 'WEB_CHAT/SET_SEND_BOX',
                    payload: {
                      text: initialSendBoxText
                    }
                  });

                invoke &&
                  next({
                    type: 'DIRECT_LINE/POST_ACTIVITY',
                    meta: {
                      method: 'keyboard'
                    },
                    payload: {
                      activity: {
                        name: 'TriggerScenario',
                        type: 'invoke',
                        value: {
                          trigger: 'covid19'
                        }
                      }
                    }
                  });
              }

              return next(action);
            };
          };
        });
      }

      const versionMeta = document.querySelector('head meta[name="botframework-webchat:bundle:version"]');

      document.getElementById('version').innerHTML = 'Version: ' + versionMeta.getAttribute('content');

      function createAttachmentMiddleware(store) {
        return function () {
          return function (next) {
            return function (card) {
              var attachment = card.attachment;
              var activities = store.getState().activities;
              var messageActivities = activities.filter(function (activity) {
                return activity.type === 'message';
              });
              var recentBotMessage = messageActivities.pop() === card.activity;

              switch (attachment.contentType) {
                case 'application/vnd.microsoft.card.adaptive':
                  return window.React.createElement(window.WebChat.Components.AdaptiveCardContent, {
                    actionPerformedClassName: 'card__action--performed',
                    content: attachment.content,
                    disabled: !recentBotMessage
                  });

                case 'application/vnd.microsoft.card.hero':
                  return window.React.createElement(window.WebChat.Components.HeroCardContent, {
                    actionPerformedClassName: 'card__action--performed',
                    content: attachment.content,
                    disabled: !recentBotMessage
                  });

                default:
                  return next(card);
              }
            };
          };
        };
      }

      fetchCDCToken().then(function (token) {
        const store = createStore(true);

        window.WebChat.renderWebChat(
          {
            attachmentMiddleware: createAttachmentMiddleware(store),
            directLine: window.WebChat.createDirectLine({
              token: token
            }),
            locale: 'en-US',
            store: store,
            styleOptions: { hideSendBox: true }
          },
          document.getElementById('webchat')
        );

        document.querySelector('#webchat > *').focus();

        if (typeof window.MutationObserver !== 'undefined') {
          const observer = new MutationObserver(function (mutation) {
            console.log(mutation);
          });

          observer.observe(
            document.querySelector('[aria-live="polite"][aria-roledescription="transcript"][role="log"]'),
            {
              attributes: true,
              characterData: true,
              childList: true,
              subtree: true
            }
          );
        }
      });
    </script>
  </body>
</html>
